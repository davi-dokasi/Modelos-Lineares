---
title: "Prevendo preços de carros com estatística"
subtitle: "Seminário de modelos lineares"
author: "Davi, Diogo, João, Thiago e Eduardo Garcez"
date: "`r Sys.Date()`"
output: rmdformats::downcute # install.packages('rmdformats')
params:
  run_chunk: true
---

![](images/cars.png)
```{r setup, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(cache   = TRUE)
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(echo    = FALSE)
```

```{r libs, include = FALSE}

packages <- c("readr",
              "dplyr",
              "ggplot2",
              "corrplot",
              "GGally",
              "knitr",
              "png",
              "rmarkdown",
              "pastecs",
              "RColorBrewer",
              "gridExtra",
              "car",
              "corrplot")

install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

lapply(packages, install_if_missing)
lapply(packages, library, character.only = TRUE)
```

```{r data, include = FALSE}

price        <- read_csv("auto-market-dataset/price.csv")
depreciation <- read_csv("auto-market-dataset/depreciation.csv")
applications <- read_csv("auto-market-dataset/applications.csv")
primary      <- read_csv("auto-market-dataset/primary_features.csv")
models       <- read_csv("auto-market-dataset/models.csv")
extra        <- read_csv("auto-market-dataset/extra_options.csv")
mans         <- read_csv("auto-market-dataset/mans.csv")

# Juntando as tabelas pelas chaves
data <- price %>%
  inner_join(extra,        by = "app_id")             %>%
  inner_join(depreciation, by = "app_id")             %>%
  inner_join(applications, by = "app_id")             %>%
  inner_join(primary,      by = "app_id")             %>%
  inner_join(mans,         by = c("man_id"   = "id")) %>%
  inner_join(models,       by = c("model_id" = "id")) %>%
  select(-ends_with(".y"))                            %>%
  rename_with(~ sub("\\.x$", "", .), ends_with(".x"))

data <- data %>%
  filter(is_car == TRUE)

data <- data %>%
  select(app_id,
         price,
         car_run_km,
         prod_year,
         engine_volume,
         cylinders,
         airbags,
         abs_break,
         esd,
         el_windows,
         conditioner,
         leather,
         nav_system,
         model_name,
         category,
         man_id,
         man_name, )

data <- data %>%
  mutate(category_num = as.numeric(as.factor(data$category)))

# Retirando registros inconsistentes
data_filter <- data %>%
  filter(price         > 1000 &
         car_run_km    > 1000 &
         engine_volume > 0    &
         cylinders     > 0)
```

# Introdução

O dataset foi escolhido pela plataforma kaggle e trata de observações sobre o **mercado automotivo online da Georgia** no ano de **2024**.

Conforme o *schema* apresentado a seguir o dataset apresenta diversos detalhes sobre as vendas, condições do carro e outrs detalhes mais específicos.

Para esse trabalho, com o intuito de enfatizar os processos e análises que foram aprendidos na disciplina, tomamos liberdade de manipular o banco fornecido no site e descartar variáveis não utilizadas no modelo.

Abaixo também apresentamos uma tabela com as variáveis que escolhemos enfatizar e serão tratadas no modelo linear simulado.

![](images/schema.png)
```{r data_head}

kable(head(data))
```


# Explorando o banco de dados
```{r pg_table}

paged_table(data)
```


## Estatísticas gerais
```{r}

aux <- stat.desc(data)
aux <- aux[c(4, 5, 8, 9, 12:14), -c(1, 8)]

rownames(aux) <- c("Mínimo",
                   "Máximo",
                   "Mediana",
                   "Média",
                   "Variância",
                   "Desvio Padrão",
                   "Coeficiente de Variação")

kable(aux, digits = 2, align = "c")
```
## Graficos das variaveis {.tabset}
```{r}

cores <- brewer.pal(6, "Set2")
```

### Preço
```{r }
p1 <- ggplot(data, aes(x = "", y = price)) +
  geom_boxplot(fill = cores[1]) +
  theme_minimal()

h1 <- ggplot(data, aes(x = log(price))) +
  geom_histogram(fill = cores[1]) +
  theme_minimal()

grid.arrange(p1, h1, nrow = 1, ncol = 2)
```

### Quilometragem
```{r}
p2 <- ggplot(data, aes(x = "", y = car_run_km)) +
  geom_boxplot(fill = cores[2]) +
  theme_minimal()

h2 <- ggplot(data, aes(x = car_run_km)) +
  geom_histogram(fill = cores[2]) +
  theme_minimal()

grid.arrange(p2, h2, nrow = 1, ncol = 2)
```

### Ano do carro
```{r }
p3 <- ggplot(data, aes(x = "", y = prod_year)) +
  geom_boxplot(fill = cores[3]) +
  theme_minimal()

h3 <- ggplot(data, aes(x = prod_year)) +
  geom_histogram(fill = cores[3]) +
  theme_minimal()

grid.arrange(p3, h3, nrow = 1, ncol = 2)
```

### Volume do motor
```{r }
p4 <- ggplot(data, aes(x = "", y = engine_volume)) +
  geom_boxplot(fill = cores[4]) +
  theme_minimal()

h4 <- ggplot(data, aes(x = engine_volume)) +
  geom_histogram(fill = cores[4]) +
  theme_minimal()

grid.arrange(p4, h4, nrow = 1, ncol = 2)
```

### Cilindros
```{r }
p5 <- ggplot(data, aes(x = "", y = cylinders)) +
  geom_boxplot(fill = cores[5]) +
  theme_minimal()

h5 <- ggplot(data, aes(x = cylinders)) +
  geom_histogram(fill = cores[5]) +
  theme_minimal()

grid.arrange(p5, h5, nrow = 1, ncol = 2)
```

### Airbags
```{r}
p6 <- ggplot(data, aes(x = "", y = airbags)) +
  geom_boxplot(fill = cores[6]) +
  theme_minimal()
h6 <- ggplot(data, aes(x = airbags)) +
  geom_histogram(fill = cores[6]) +
  theme_minimal()

grid.arrange(p6, h6, nrow = 1, ncol = 2)
```

## Equação do modelo linear

A equação do modelo linear é dada por:

$$
\text{price} = \beta_0 + \beta_1 \cdot \text{car_run_km} + \beta_2 \cdot \text{prod_year} + \beta_3 \cdot \text{engine_volume} + \beta_4 \cdot \text{cylinders} + \beta_5 \cdot \text{airbags} + \beta_6 \cdot \text{abs_break} + \beta_7 \cdot \text{esd} + \beta_8 \cdot \text{el_windows} + \beta_9 \cdot \text{conditioner} + \beta_10 \cdot \text{leather} + \beta_11 \cdot \text{nav_system}
$$

```{r mult 1}

model_filter <- lm(price ~ car_run_km
                  + prod_year
                  + engine_volume
                  + cylinders
                  + airbags
                  + abs_break
                  + esd
                  + el_windows
                  + conditioner
                  + leather
                  + nav_system, data = data_filter)

summary(model_filter)
```

Apenas algumas variáveis apresentaram significância no modelo. Assim, o próximo modelo será construído excluindo as variáveis com p-valor maior que 0,05

```{r mult 2}
model_filter <- lm(price ~ car_run_km
                  + prod_year
                  + engine_volume
                  + cylinders
                  + airbags
                  + abs_break
                  + nav_system, data = data_filter)

summary(model_filter)
```

## Interpretação dos Coeficientes

$$
\text{price} = \beta_0 + \beta_1 \cdot \text{car_run_km} + \beta_2 \cdot \text{prod_year} + \beta_3 \cdot \text{engine_volume} + \beta_4 \cdot \text{cylinders} + \beta_5 \cdot \text{airbags} + \beta_6 \cdot \text{abs_break}  + \beta_7 \cdot \text{nav_system}
$$

- $\beta_0$ (intercept) nos indica que o valor esperado quando do veículo quando todas variáveis independentes são iguais a zero. Logo o beta_0 não tem interpretação prática pois o ano de produção não pode ser 0.

- ***car_run_km*** (Quilometragem): Para cada quilômetro adicional rodado, o preço do veículo diminuí em média -0.02 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***prod_year*** (Ano de produção): Para cada ano adicional de produção, o preço do veículo aumenta em média 634.40 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***engine_volume*** (volume do motor) : Para cada unidade adicional no volume do motor, o preço do veículo aumenta em média 2.47 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***cylinders*** (cilindro adicional):  Para cada cilindro adicional, o preço do veículo aumenta em média 1682.0 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***airbags*** Para cada airbags, o preço do veículo diminui em média -423.1 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***abs_break*** (Sistema de freio)  Para presença de ABS, o aumento esperado na variável resposta é 1905 unidades monetárias, mantendo todas as outras variáveis constantes.

- ***nav_system*** (Sistema de navegação) Para presença de Sistema de navegação, o aumento esperado na variável resposta é 1389 unidades monetárias, mantendo todas as outras variáveis constantes.

## Interpretação do teste F

**F-statistic**: 248.9 \
**p-valor**: < 2.2e-16 \
**Adjusted R-squared**: 0.03107

- **F-statistic**: O valor de 248.9 indica que a variabilidade explicada pelo modelo é significativamente maior do que a variabilidade não explicada. Em outras palavras, o modelo como um todo é significativo.

- **p-valo**r: O p-valor é extremamente pequeno (< 2.2e-16), o que significa que a probabilidade de observar um valor de F tão extremo, ou mais extremo, sob a hipótese nula é praticamente zero.

- **Adjusted R-squared**: Apenas cerca de 3.1% da variabilidade dos dados observados é explicada pelo modelo ajustado.

- **Conclusão**:
  Apesar do modelo ser estatisticamente significativo como um todo, com um p-valor extremamente pequeno (< 2.2e-16), sua capacidade explicativa é muito limitada, conforme evidenciado pelo $R^2$ ajustado de apenas 3.1%. Isso indica que o modelo consegue explicar apenas uma pequena fração da variabilidade nos preços dos carros.

  Portanto, prosseguiremos com a análise detalhada dos resíduos, buscando identificar possíveis outliers ou padrões que possam estar influenciando negativamente o desempenho do modelo e comprometendo sua capacidade preditiva.

## Voltando a equação...

$$
\text{price} = \beta_0 + \beta_1 \cdot \text{car_run_km} + \beta_2 \cdot \text{prod_year} + \beta_3 \cdot \text{engine_volume} + \beta_4 \cdot \text{cylinders} + \beta_5 \cdot \text{airbags} + \beta_6 \cdot \text{abs_break}  + \beta_7 \cdot \text{nav_system}
$$
Substituindo os valores dos coeficientes estimados, temos:

$$
\begin{align*}
\text{price} = &\ -1,275,000 - 0.02198 \cdot \text{car_run_km} + 634.4 \cdot \text{prod_year} + 2.478 \cdot \text{engine_volume} \\
&+ 1,682 \cdot \text{cylinders} - 423.1 \cdot \text{airbags} + 1,905 \cdot \text{abs_break} + 1,389 \cdot \text{nav_system}
\end{align*}
$$

## Multicolinearidade

```{r multicolinearidade, echo=FALSE}
data_filter <- data_filter %>%
  select(nav_system,
         price,
         car_run_km,
         prod_year,
         cylinders,
         airbags,
         abs_break,
         engine_volume)

# Cálculo do VIF
vif_values <- vif(model_filter)
kable(vif_values, col.names = c("VIF"))

corrplot(cor(data_filter), method="number", order="hclust", addrect=2, diag=F)
```

Apesar de o Fator de Inflação da Variância (VIF) ter apresentado valores inferiores a 3 para todas as variáveis do modelo, indicando que não há evidências significativas de multicolinearidade de acordo com essa métrica, é importante complementar a análise observando a matriz de correlação entre as variáveis explicativas.

Ao examinar as correlações, identificamos que:

- A correlação entre as variáveis abs_break e nav_system é de 0.66, indicando uma relação moderada entre essas variáveis.

- A correlação entre engine_volume e cylinders é de 0.71, o que caracteriza uma relação mais forte e potencialmente problemática.

Portanto iremos retirar do modelo uma variável: **engine_volume**.


## Análise de resíduos



## Transformação em log escala


```{r modelo log}
model_log <- lm(log(price) ~ car_run_km
                  + prod_year
                  + cylinders
                  + airbags
                  + abs_break
                + nav_system,
                data = data_filter)


summary(model_log)
```
